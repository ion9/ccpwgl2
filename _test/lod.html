<!DOCTYPE html>
<html>
<head>
    <title>LOD Tests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <script type="text/javascript" src="../dist/ccpwgl2_int.js"></script>
    <script type="text/javascript" src="../dist/ccpwgl.js"></script>

    <style>

        #mainCanvas {
            border: none;
            position: fixed;
            width: 100%;
            height: 100%
        }

    </style>

    <script type="text/javascript">
        var object, camera, scene, canvas, planet;
        var originalMesh, lodMesh, wrapped;

        function OnDocLoad()
        {
            // Set obvious thresholds
            ccpwgl_int.EveSpaceObject.LOD_THRESHOLD_NONE = 400;
            ccpwgl_int.EveSpaceObject.LOD_THRESHOLD_LOW = 800;
            ccpwgl_int.EveSpaceObject.LOD_THRESHOLD_MEDIUM = 1000;

            /**
             * Fires on object load
             */
            function onObjectLoad()
            {
                wrapped = this.wrappedObjects[0];
                originalMesh = wrapped.mesh;

                // Create lod mesh and copy original areas
                lodMesh = new ccpwgl_int.Tr2MeshLod();
                lodMesh.opaqueAreas = Array.from(originalMesh.opaqueAreas);
                lodMesh.transparentAreas = Array.from(originalMesh.transparentAreas);

                // Create lodResource with all quality level models
                lodMesh.geometryRes = new ccpwgl_int.Tw2LodResource();
                lodMesh.geometryRes.lowDetailResPath = "res:/dx9/model/jumpgate/minmatar/mbg/mbg_lowdetail.wbg";
                lodMesh.geometryRes.mediumDetailResPath = "res:/dx9/model/jumpgate/minmatar/mbg/mbg_mediumdetail.wbg";
                lodMesh.geometryRes.highDetailResPath = "res:/dx9/model/jumpgate/minmatar/mbg/mbg.wbg";
                lodMesh.Initialize();

                wrapped.mesh = lodMesh;
                camera.focus(this, 4, 0);

                // Log changes to lod
                lodMesh.OnEvent("lod_changed", function(e)
                {
                    console.log("Lod: " + e.level);
                    console.log("Pixels: " + wrapped._pixels);
                });
            }

            /**
             * Fires on scene load
             */
            function onSceneLoaded()
            {
                this.wrappedScene.EnableLod(1);
            }

            canvas = document.getElementById('mainCanvas');
            ccpwgl.initialize(canvas, {});
            camera = ccpwgl.createCamera(canvas, {nearPlane: 10, farPlane: 10000000}, true);
            scene = ccpwgl.loadScene('res:/dx9/scene/universe/m10_cube.red', onSceneLoaded);
            object = scene.loadObject('mbg:minmatarbase:minmatar', onObjectLoad);

            planet = scene.loadPlanet(40000004,
                'res:/dx9/model/WorldObject/Planet/Template/Moon/p_moon_51.red',
                undefined,
                'res:/dx9/model/worldobject/planet/Moon/Moon01_H.dds.0.png',
                'res:/dx9/model/worldobject/planet/Moon/Moon03_H.dds.0.png'
            );

            planet.setTransform([
                50000, 0, 0, 0,
                0, 50000, 0, 0,
                0, 0, 50000, 0,
                50000,50000,50000,1
            ]);
        }
    </script>

</head>
<body onload="OnDocLoad()">
<canvas id="mainCanvas" width="500" height="500"></canvas>
</body>
</html>